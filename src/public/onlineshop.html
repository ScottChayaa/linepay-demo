<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE PAY 線上付款</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            text-align: center;
        }
        h4 {
            color: #333;
            margin-bottom: 30px;
        }
        img {
            display: block;
            margin: 0 auto 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        button {
            background-color: #00B900;
            color: white;
            border: none;
            padding: 12px 40px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        button:hover {
            background-color: #009900;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }
        .product-info {
            margin: 20px 0 30px;
        }
        .product-name {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .product-price {
            font-size: 24px;
            color: #E60012;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h4>LINE PAY 線上付款</h4>

    <img src="https://store.storeimages.cdn-apple.com/1/as-images.apple.com/is/iphone-17-pro-model-unselect-gallery-2-202509?wid=5120&hei=2880&fmt=webp&qlt=90&.v=dU9qRExIQUlQTzVKeDd1V1dtUE1MUWFRQXQ2R0JQTk5udUZxTkR3ZVlpTEVqWElVVkRpc1V5YU5kb3VzUVZndzBoUVhuTWlrY2hIK090ZGZZbk9HeEJWb1BiTjRORlc1Y1lKU3JWempySktQVFcxaWdDV1ZRTjhLQ2h5TEk5bUxmbW94YnYxc1YvNXZ4emJGL0IxNFp3&traceId=1"
         width="300"
         alt="iPhone 17 Pro">

    <div class="product-info">
        <div class="product-name">買不起的 iphone 17</div>
        <div class="product-price">NTD 500</div>
    </div>

    <button id="payButton" onclick="handlePayment()">線上付款</button>

    <textarea id="responseArea" placeholder="API 回應將顯示在這裡..."></textarea>

    <script>
        async function handlePayment() {
            const button = document.getElementById('payButton');
            const textarea = document.getElementById('responseArea');

            try {
                button.disabled = true;
                button.textContent = '處理中...';
                textarea.value = '正在呼叫 API...\n';

                const response = await axios.get('/payments/request');

                textarea.value += '\n成功!\n\n';
                textarea.value += JSON.stringify(response.data, null, 2);

                // 取得付款網址
                const paymentUrl = response.data?.info?.paymentUrl?.web;

                if (paymentUrl) {
                    // 顯示倒數跳轉訊息
                    let timerInterval;
                    await Swal.fire({
                        title: '正為您導向線上付款頁面',
                        html: '將在 <b>3</b> 秒後跳轉...',
                        timer: 3000,
                        timerProgressBar: true,
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        allowEnterKey: false,
                        showConfirmButton: false,
                        backdrop: `
                            rgba(0,0,0,0.9)
                        `,
                        didOpen: () => {
                            const timer = Swal.getPopup().querySelector('b');
                            timerInterval = setInterval(() => {
                                const timeLeft = Math.ceil(Swal.getTimerLeft() / 1000);
                                timer.textContent = timeLeft;
                            }, 100);
                        },
                        willClose: () => {
                            clearInterval(timerInterval);
                        }
                    });

                    // 跳轉到付款頁面
                    window.location.href = paymentUrl;
                }

            } catch (error) {
                textarea.value += '\n錯誤!\n\n';
                if (error.response) {
                    textarea.value += JSON.stringify(error.response.data, null, 2);
                } else {
                    textarea.value += error.message;
                }
            } finally {
                button.disabled = false;
                button.textContent = '線上付款';
            }
        }
    </script>
</body>
</html>